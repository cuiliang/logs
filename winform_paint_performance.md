# 优化绘制性能

## 在OnPaint中，根据ClipRectangle，只绘制必要的部分。

在截图模块绘制背景时，绘制整个背景图和仅绘制刷新区域的图：
```c#
Stopwatch watch = new Stopwatch();
  long t1, t2;
            
             watch.Start();
            e.Graphics.DrawImageUnscaled(_backgroundImage, Point.Empty);
            t1 = watch.ElapsedTicks;
            
            watch.Restart();
            e.Graphics.DrawImage(_backgroundImage, e.ClipRectangle, e.ClipRectangle, GraphicsUnit.Pixel);
            t2 = watch.ElapsedTicks;
                
                    
            
            Debug.WriteLine($"绘制背景耗时：{t1}, {t2}, {(t1-t2)*1.0/t1}  {e.ClipRectangle}");
```
测试结果：
1) 如果先绘制整图，再绘制Clip区域：绘制Clip区域比整图快10-20%左右，极个别会慢。
```
绘制背景耗时：1192318, 813741, 0.317513448593412  {X=0,Y=0,Width=9840,Height=3840}
绘制背景耗时：41950, 36199, 0.137091775923719  {X=5631,Y=1315,Width=455,Height=308}
绘制背景耗时：38294, 34978, 0.086593199979109  {X=5811,Y=1341,Width=275,Height=289}
绘制背景耗时：36704, 33808, 0.0789014821272886  {X=5801,Y=1348,Width=276,Height=285}
绘制背景耗时：36308, 33881, 0.066844772501928  {X=5783,Y=1351,Width=284,Height=289}
绘制背景耗时：37498, 33945, 0.0947517200917382  {X=5754,Y=1358,Width=295,Height=288}
绘制背景耗时：38387, 35167, 0.0838825644098262  {X=5706,Y=1364,Width=314,Height=292}
绘制背景耗时：37503, 35008, 0.0665280110924459  {X=5617,Y=1374,Width=355,Height=291}
绘制背景耗时：39675, 35170, 0.113547574039067  {X=5550,Y=1383,Width=333,Height=288}
绘制背景耗时：36560, 34543, 0.0551695842450766  {X=5476,Y=1389,Width=340,Height=287}
绘制背景耗时：38681, 34423, 0.110079884180864  {X=5386,Y=1394,Width=356,Height=285}
绘制背景耗时：36122, 34666, 0.0403078456342395  {X=5293,Y=1397,Width=359,Height=282}
绘制背景耗时：36742, 33901, 0.077322954656796  {X=5192,Y=1397,Width=367,Height=282}
绘制背景耗时：37428, 35222, 0.0589398311424602  {X=4945,Y=1397,Width=513,Height=282}
绘制背景耗时：37161, 32701, 0.12001829875407  {X=4819,Y=1397,Width=392,Height=282}
绘制背景耗时：37623, 34201, 0.090955000930282  {X=4698,Y=1397,Width=387,Height=282}
绘制背景耗时：36690, 34657, 0.0554101935132189  {X=4584,Y=1397,Width=380,Height=282}
绘制背景耗时：37112, 33550, 0.0959797370122871  {X=4471,Y=1397,Width=379,Height=282}
绘制背景耗时：38071, 33488, 0.120380341992593  {X=4366,Y=1397,Width=371,Height=282}
绘制背景耗时：38569, 35545, 0.0784049366071197  {X=4174,Y=1392,Width=458,Height=287}
绘制背景耗时：37462, 33757, 0.0989002188884737  {X=4108,Y=1390,Width=332,Height=284}
```

2) 如果先绘制区域，再绘制整图，则快40-50% (猜测原因：绘制整图比较耗费GDI资源，所以后面绘制的那个操作会比较吃亏）
```
绘制背景耗时：1933977, 1129525, 0.415957376949157  {X=0,Y=0,Width=9840,Height=3840}
绘制背景耗时：89964, 46212, 0.486327864479125  {X=5169,Y=1570,Width=508,Height=348}
绘制背景耗时：74839, 39090, 0.477678750384158  {X=5093,Y=1554,Width=342,Height=298}
绘制背景耗时：73527, 37793, 0.485998340745576  {X=5048,Y=1539,Width=311,Height=297}
绘制背景耗时：73115, 36582, 0.499664911440881  {X=4996,Y=1529,Width=318,Height=292}
绘制背景耗时：72129, 36822, 0.489497982780851  {X=4945,Y=1521,Width=317,Height=290}
绘制背景耗时：76195, 39619, 0.480031498129799  {X=4840,Y=1498,Width=371,Height=305}
绘制背景耗时：73286, 37649, 0.486272958000164  {X=4781,Y=1487,Width=325,Height=293}
绘制背景耗时：708892, 401330, 0.433862986181252  {X=3829,Y=728,Width=3862,Height=2122}
绘制背景耗时：87586, 45971, 0.475133012125226  {X=4444,Y=1419,Width=551,Height=340}
绘制背景耗时：129789, 70164, 0.459399486859441  {X=4296,Y=1195,Width=464,Height=509}
绘制背景耗时：79398, 40669, 0.487783067583566  {X=4424,Y=1399,Width=305,Height=324}
绘制背景耗时：85562, 45154, 0.472265725438863  {X=4424,Y=1399,Width=323,Height=338}
绘制背景耗时：91825, 48059, 0.476624013068337  {X=4424,Y=1399,Width=351,Height=355}
绘制背景耗时：101007, 52848, 0.476788737414239  {X=4424,Y=1399,Width=430,Height=398}
```
